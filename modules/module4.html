<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />
  <title>Module 4: UV Light</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'], heading: ['Montserrat','ui-sans-serif','system-ui'] },
          colors: { bg: '#17171a', card: '#2f2f34', muted: '#b7b7bb' }
        }
      }
    }
  </script>
  <script type="module" src="../algo/firebase.js"></script>
  <script src="../algo/algo.js"></script>
</head>
<body>
  <div class="min-h-dvh flex flex-col items-center bg-bg text-white font-sans">
    <div class="w-full max-w-[420px] flex flex-col min-h-dvh px-4 sm:px-6 mt-[20px]">
      <!-- top bar -->
      <div class="flex items-center gap-2 justify-start mt-1 mb-3 sm:mb-5">
        <button class="w-[40px] h-[40px] rounded-xl bg-[#1f1f23] border border-white/10 text-muted flex items-center justify-center" onclick="window.location.href='index.html'" aria-label="Back">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div class="flex-1 text-center">
          <p class="font-heading font-bold text-[18px] leading-tight m-0">Module 4</p>
          <p class="font-semibold text-[#d9d9dc] text-[14px] mt-0.5">UV Light</p>
        </div>
        <div class="w-10"></div>
      </div>

      <main class="flex-1 space-y-4">
        <!-- What is UV Light card -->
        <section class="bg-[#3b3b41] border border-white/10 rounded-2xl p-5 shadow-[0_10px_30px_rgba(0,0,0,0.24)]" aria-label="What is UV Light?">
          <h1 class="font-heading text-2xl font-extrabold mb-2">What is UV Light</h1>
          <p class="text-[#e9e9ec] leading-relaxed text-sm">UV light is invisible to our eyes but reveals hidden details by making some substances glow.</p>
        </section>

        <!-- Normal Light View card -->
        <section class="bg-[#3b3b41] border border-white/10 rounded-2xl p-5 shadow-[0_10px_30px_rgba(0,0,0,0.24)]" aria-label="Normal Light View">
          <div class="w-full flex flex-col items-center justify-center text-center">
            <h2 class="font-heading text-lg font-extrabold">Normal Light View</h2>
            <div class="mt-3 flex items-center gap-3">
              <button id="toggleBtn" class="rounded-lg px-3 py-2 font-semibold bg-black/60 text-white hover:bg-black/70 border border-white/10">Toggle UV View</button>
            </div>
          </div>

          <div class="mt-4">
            <div id="previewSurface" class="relative rounded-xl border border-white/10 bg-[#2a2a2f] h-[180px] overflow-hidden">
              <!-- Glow overlay for UV -->
              <div id="uvGlow" class="absolute inset-0 opacity-0 transition-opacity duration-300"></div>
              <!-- Normal layer -->
              <div id="normalLayer" class="absolute inset-0 grid place-items-center opacity-100 transition-opacity duration-300">
                <div class="text-center">
                  <div class="text-white/60 text-2xl"><i class="fa-regular fa-eye"></i></div>
                  <div class="text-white/60 text-sm mt-1">Blank surface</div>
                </div>
              </div>
              <!-- UV layer -->
              <div id="uvLayer" class="absolute inset-0 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
                <i class="fa-solid fa-bolt text-violet-300 text-xl" style="filter: drop-shadow(0 0 12px rgba(167,139,250,0.95));"></i>
                <div class="mt-3 space-y-2">
                  <div class="h-[10px] w-24 rounded-full border border-violet-300/70 bg-violet-400/20 shadow-[0_0_20px_4px_rgba(167,139,250,0.6)]"></div>
                  <div class="h-[10px] w-36 rounded-full border border-violet-300/70 bg-violet-400/20 shadow-[0_0_24px_4px_rgba(167,139,250,0.7)]"></div>
                  <div class="h-[10px] w-20 rounded-full border border-violet-300/70 bg-violet-400/20 shadow-[0_0_20px_4px_rgba(167,139,250,0.6)]"></div>
                </div>
                <div class="mt-3 text-violet-300 text-sm" style="text-shadow:0 0 14px rgba(167,139,250,0.9);">Glowing evidence</div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- footer controls -->
      <div class="mt-auto sticky bottom-4">
        <div class="flex gap-3">
          <button class="flex-1 rounded-xl py-3.5 px-5 font-bold text-white bg-gradient-to-b from-[#ff6b6b] to-[#e23b3b] shadow-[0_10px_24px_rgba(226,59,59,0.25)] active:translate-y-px" id="nextBtn">Next →</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
  const toggleBtn = document.getElementById('toggleBtn');
  const previewSurface = document.getElementById('previewSurface');
  const uvGlow = document.getElementById('uvGlow');
  const normalLayer = document.getElementById('normalLayer');
  const uvLayer = document.getElementById('uvLayer');
  const nextBtn = document.getElementById('nextBtn');
  const mainEl = document.querySelector('main');
   let step = 1;
   let subStep = 1; // for mini guide in step 3

      let uv = false;
      function render(){
        if (!previewSurface || !uvGlow || !normalLayer || !uvLayer) return;
        if (!uv){
          // Normal view
          uvGlow.style.background = 'transparent';
          uvGlow.classList.remove('opacity-100');
          uvGlow.classList.add('opacity-0');
          uvLayer.classList.remove('opacity-100');
          uvLayer.classList.add('opacity-0');
          normalLayer.classList.remove('opacity-0');
          normalLayer.classList.add('opacity-100');
        } else {
          // UV view with glowing evidence effect
          uvGlow.style.background = 'radial-gradient(circle at 50% 50%, rgba(167,139,250,0.45) 0%, rgba(167,139,250,0.25) 38%, rgba(167,139,250,0.12) 58%, rgba(0,0,0,0) 80%)';
          uvGlow.classList.remove('opacity-0');
          uvGlow.classList.add('opacity-100');
          uvLayer.classList.remove('opacity-0');
          uvLayer.classList.add('opacity-100');
          normalLayer.classList.remove('opacity-100');
          normalLayer.classList.add('opacity-0');
        }
      }

      if (toggleBtn) toggleBtn.addEventListener('click', ()=>{ uv = !uv; render(); });
      function renderMiniGuide(){
        if (!mainEl) return;
        // hide sticky footer Next during mini guide
        if (nextBtn) nextBtn.classList.add('hidden');

        const dots = Array.from({length:5}).map((_,i)=>
          `<span class="w-2 h-2 rounded-full ${i+1===subStep?'bg-violet-500':'bg-white/20'}"></span>`
        ).join('');

        function miniCard(){
          if (subStep === 1){
            return `
              <div class="text-white/90 text-sm font-semibold">1</div>
              <div class="mx-auto my-3 text-violet-400 text-4xl"><i class="fa-solid fa-moon"></i></div>
              <h3 class="font-heading text-lg font-extrabold">Darken the Environment</h3>
              <p class="text-white/70 text-sm">Remove background light sources</p>
            `;
          } else if (subStep === 2){
            return `
              <div class="text-white/90 text-sm font-semibold">2</div>
              <div class="mx-auto my-3 text-violet-400 text-4xl"><i class="fa-solid fa-bolt"></i></div>
              <h3 class="font-heading text-lg font-extrabold">Shine UV Light at Evidence</h3>
              <p class="text-white/70 text-sm">Experiment with different angles</p>
            `;
          } else if (subStep === 3){
            return `
              <div class="text-white/90 text-sm font-semibold">3</div>
              <div class="mx-auto my-3 text-violet-400 text-4xl"><i class="fa-solid fa-camera"></i></div>
              <h3 class="font-heading text-lg font-extrabold">Mount Camera on Tripod</h3>
              <p class="text-white/70 text-sm">Prevent blur during long exposures</p>
            `;
          } else if (subStep === 4){
            return `
              <div class="text-white/90 text-sm font-semibold">4</div>
              <div class="mx-auto my-3 text-violet-400 text-4xl"><i class="fa-solid fa-filter"></i></div>
              <h3 class="font-heading text-lg font-extrabold">Attach UV/Barrier Filter</h3>
              <p class="text-white/70 text-sm">Capture only fluorescence</p>
            `;
          }
          return `
            <div class="text-white/90 text-sm font-semibold">5</div>
            <div class="mx-auto my-3 text-violet-400 text-4xl"><i class="fa-solid fa-copy"></i></div>
            <h3 class="font-heading text-lg font-extrabold">Take Multiple Shots</h3>
            <p class="text-white/70 text-sm">Adjust exposure for clarity</p>
          `;
        }

        mainEl.innerHTML = `
          <section class="text-center mb-4">
            <h1 class="font-heading font-extrabold text-2xl leading-tight">How to Apply UV Light</h1>
            <div class="mt-2 text-white font-bold">3</div>
            <p class="text-white/70 text-sm mt-1">Step-by-step technique guide</p>
            <div class="flex justify-center gap-2 mt-2">${dots}</div>
          </section>

          <section class="bg-[#2b2b30] border border-white/10 rounded-2xl p-6 mt-10 py-20 mx-auto text-center shadow-[0_10px_30px_rgba(106,33,255,0.25)] ring-1 ring-violet-500/30">
            ${miniCard()}
          </section>
          <div class="mt-10 space-y-4">
            <div class="mt-10 flex items-center justify-center gap-2">
              <button id="miniPrev" class="rounded-lg px-3 py-2 font-semibold text-white/90 border border-white/15 bg-white/5">&lt;</button>
              <button id="miniNext" class="rounded-lg px-3 py-2 font-semibold text-white/90 border border-white/15 bg-white/5">&gt;</button>
            </div>
          </div>
          <div class="fixed left-0 right-0 bottom-4 flex items-center justify-center px-4 z-50 pointer-events-none">
            <div class="w-full max-w-[420px] flex items-center justify-between pointer-events-auto">
              <button id="miniBack" class="rounded-xl py-2.5 px-4 font-semibold text-white/90 border border-white/15 bg-white/5">Back</button>
              <button id="miniPractice" class="rounded-xl py-2.5 px-4 font-bold text-white bg-gradient-to-b from-[#ff6b6b] to-[#e23b3b]">Next: Practice →</button>
            </div>
          </div>
        `;

        // wire mini controls
        const prev = document.getElementById('miniPrev');
        const next = document.getElementById('miniNext');
        const back = document.getElementById('miniBack');
        const practiceBtn = document.getElementById('miniPractice');

        prev.addEventListener('click', ()=>{ if (subStep>1){ subStep--; renderMiniGuide(); } });
        next.addEventListener('click', ()=>{ if (subStep<5){ subStep++; renderMiniGuide(); } });
        back.addEventListener('click', ()=>{ step = 2; subStep = 1; if (nextBtn) nextBtn.classList.remove('hidden'); renderUseCases(); });
        practiceBtn.addEventListener('click', ()=>{
          step = 4; // practice mode
          renderPractice();
        });
      }

      function renderUseCases(){
        if (!mainEl) return;
        if (nextBtn) nextBtn.classList.remove('hidden');
        mainEl.innerHTML = `
          <section class="bg-[#3b3b41] border border-white/10 rounded-2xl p-4 shadow-[0_10px_30px_rgba(0,0,0,0.24)]">
            <h2 class="font-heading text-xl font-extrabold">Forensic Use Cases</h2>
          </section>

          <section class="grid grid-cols-2 gap-3 mt-1">
            <div class="bg-[#3b3b41] border border-white/10 rounded-2xl p-4 text-center">
              <div class="text-[#ff3b3f] text-4xl mb-2"><i class="fa-solid fa-fingerprint"></i></div>
              <div class="font-semibold">Fingerprints</div>
              <div class="text-white/60 text-xs">Latent fingerprints<br/>(after treatment)</div>
            </div>
            <div class="bg-[#3b3b41] border border-white/10 rounded-2xl p-4 text-center">
              <div class="text-[#ff3b3f] text-4xl mb-2"><i class="fa-solid fa-droplet"></i></div>
              <div class="font-semibold">Biological Fluids</div>
              <div class="text-white/60 text-xs">Blood, semen,<br/>saliva</div>
            </div>
            <div class="bg-[#3b3b41] border border-white/10 rounded-2xl p-4 text-center">
              <div class="text-[#ff3b3f] text-4xl mb-2"><i class="fa-solid fa-person"></i></div>
              <div class="font-semibold">Injuries</div>
              <div class="text-white/60 text-xs">Bruises bite marks<br/>under skin</div>
            </div>
            <div class="bg-[#3b3b41] border border-white/10 rounded-2xl p-4 text-center">
              <div class="text-[#ff3b3f] text-4xl mb-2"><i class="fa-solid fa-feather"></i></div>
              <div class="font-semibold">Fibers & Hairs</div>
              <div class="text-white/60 text-xs">Materials that<br/>fluoresce</div>
            </div>
            <div class="bg-[#3b3b41] border border-white/10 rounded-2xl p-4 text-center col-span-2">
              <div class="text-[#ff3b3f] text-4xl mb-2"><i class="fa-solid fa-file-lines"></i></div>
              <div class="font-semibold">Documents</div>
              <div class="text-white/60 text-xs">Altered/ forged<br/>documents</div>
            </div>
          </section>
        `;
      }

      if (nextBtn){
        nextBtn.addEventListener('click', ()=>{
          if (step === 1){
            step = 2; renderUseCases();
          } else if (step === 2){
            step = 3; renderMiniGuide();
          }
        });
      }

      // Practice simulation: drag UV tool to reveal hidden item
      function renderPractice(){
        if (!mainEl) return;
        if (nextBtn) nextBtn.classList.add('hidden');

        mainEl.innerHTML = `
          <section class="text-center mb-3">
            <h1 class="font-heading font-extrabold text-2xl leading-tight">Practice: UV Sweep</h1>
            <p class="text-white/70 text-sm mt-1">Drag the UV tool around. When you get close, hidden evidence will appear.</p>
          </section>

          <section id="practiceStage" class="relative mx-auto mt-2 h-[300px] rounded-2xl border border-white/10 bg-[#2a2a2f] overflow-hidden">
            <!-- Hidden evidence: three glowing lines -->
            <div id="evidence-lines" class="ev absolute right-8 bottom-8 opacity-0 transition-opacity duration-150" data-type="lines">
              <div class="w-20 h-[6px] rounded-full bg-violet-400/40 border border-violet-300/70 shadow-[0_0_18px_4px_rgba(167,139,250,0.55)] mb-1"></div>
              <div class="w-16 h-[6px] rounded-full bg-violet-400/40 border border-violet-300/70 shadow-[0_0_18px_4px_rgba(167,139,250,0.55)] mb-1"></div>
              <div class="w-24 h-[6px] rounded-full bg-violet-400/40 border border-violet-300/70 shadow-[0_0_18px_4px_rgba(167,139,250,0.55)]"></div>
            </div>

            <!-- Hidden evidence: fingerprint icon -->
            <div class="ev absolute left-8 top-8 opacity-0 transition-opacity duration-150 text-violet-300 text-3xl" data-type="icon" style="filter: drop-shadow(0 0 12px rgba(167,139,250,0.9));">
              <i class="fa-solid fa-fingerprint"></i>
            </div>

            <!-- Hidden evidence: droplet icon -->
            <div class="ev absolute right-12 top-14 opacity-0 transition-opacity duration-150 text-violet-300 text-3xl" data-type="icon" style="filter: drop-shadow(0 0 12px rgba(167,139,250,0.9));">
              <i class="fa-solid fa-droplet"></i>
            </div>

            <!-- Hidden evidence: document icon -->
            <div class="ev absolute left-1/2 -translate-x-1/2 bottom-16 opacity-0 transition-opacity duration-150 text-violet-300 text-3xl" data-type="icon" style="filter: drop-shadow(0 0 12px rgba(167,139,250,0.9));">
              <i class="fa-solid fa-file-lines"></i>
            </div>

            <!-- Draggable UV tool -->
      <div id="uvHandle" class="absolute left-6 w-12 h-12 rounded-full border border-white/15 bg-black/60 text-violet-300 grid place-items-center cursor-grab select-none"
                 style="box-shadow: 0 0 20px rgba(167,139,250,0.35); touch-action: none;">
              <i class="fa-solid fa-bolt text-xl" style="filter: drop-shadow(0 0 8px rgba(167,139,250,0.9));"></i>
              <!-- UV beam glow -->
              <div id="uvBeam" class="pointer-events-none absolute inset-0 -z-10" style="width:220px;height:220px;left:-104px;top:-104px;border-radius:9999px;background:radial-gradient(circle, rgba(167,139,250,0.42) 0%, rgba(167,139,250,0.18) 48%, rgba(167,139,250,0.06) 70%, rgba(0,0,0,0) 85%);"></div>
            </div>

            <div id="foundBadge" class="hidden absolute left-1/2 -translate-x-1/2 bottom-3 rounded-full px-3 py-1.5 text-sm font-semibold bg-green-500/20 text-green-300 border border-green-400/30">Evidence found!</div>
            <div id="counterBadge" class="absolute left-3 top-3 rounded-full px-2.5 py-1 text-xs font-semibold bg-white/10 text-white/80 border border-white/15">Found 0/4</div>
          </section>

          <div class="mt-4 flex items-center justify-between">
            <button id="practiceBack" class="rounded-xl py-2.5 px-4 font-semibold text-white/90 border border-white/15 bg-white/5">Back</button>
            <div class="flex gap-2">
              <button id="practiceReset" class="rounded-xl py-2.5 px-4 font-semibold text-white/90 border border-white/15 bg-white/5">Reset</button>
              <button id="practiceDone" class="rounded-xl py-2.5 px-4 font-bold text-white bg-gradient-to-b from-[#ff6b6b] to-[#e23b3b]">Done</button>
            </div>
          </div>
        `;

        const stage = document.getElementById('practiceStage');
        const handle = document.getElementById('uvHandle');
  const evidenceEls = stage.querySelectorAll('.ev');
  const foundBadge = document.getElementById('foundBadge');
  const counterBadge = document.getElementById('counterBadge');
        const backBtn = document.getElementById('practiceBack');
        const resetBtn = document.getElementById('practiceReset');
        const doneBtn = document.getElementById('practiceDone');

        let dragging = false;
        let offsetX = 0, offsetY = 0;

        function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

        const foundSet = new Set();

        function updateReveal(){
          const h = handle.getBoundingClientRect();
          const hc = { x: h.left + h.width/2, y: h.top + h.height/2 };
          let anyFound = false;
          evidenceEls.forEach((el, idx)=>{
            const r = el.getBoundingClientRect();
            const ec = { x: r.left + r.width/2, y: r.top + r.height/2 };
            const dx = hc.x - ec.x;
            const dy = hc.y - ec.y;
            const d = Math.hypot(dx, dy);
            // Per-type detection radius and opacity mapping
            const type = el.dataset.type || 'generic';
            const baseThreshold = 130; // px for generic
            const linesThreshold = 165; // wider detection radius for lines
            const iconThreshold = 180; // wider detection radius for icons
            const threshold = type === 'icon' ? iconThreshold : (type === 'lines' ? linesThreshold : baseThreshold);
            const t = clamp(1 - d/threshold, 0, 1);
            // Lower max opacity for icons to keep them subtler
            if (type === 'icon') {
              el.style.opacity = (0.06 + 0.54*t).toString();
            } else {
              el.style.opacity = (0.12 + 0.88*t).toString();
            }
            // Per-type found cutoff: make lines easier to "find"
            const foundCutoff = type === 'lines' ? 0.9 : 0.98;
            if (t >= foundCutoff){
              anyFound = true;
              foundSet.add(idx);
            }
          });
          counterBadge.textContent = `Found ${foundSet.size}/${evidenceEls.length}`;
          if (anyFound){ foundBadge.classList.remove('hidden'); } else { foundBadge.classList.add('hidden'); }
        }

        function setHandle(left, top){
          const s = stage.getBoundingClientRect();
          const w = handle.offsetWidth, h = handle.offsetHeight;
          left = clamp(left, 6, s.width - w - 6);
          top  = clamp(top, 6, s.height - h - 6);
          handle.style.left = left + 'px';
          handle.style.top = top + 'px';
          updateReveal();
        }

        // Start position
        setTimeout(()=>{
          const s = stage.getBoundingClientRect();
          setHandle(16, s.height/2 - handle.offsetHeight/2);
        }, 0);

        function onPointerDown(e){
          dragging = true;
          handle.setPointerCapture?.(e.pointerId);
          const rect = handle.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          handle.classList.remove('cursor-grab');
          handle.classList.add('cursor-grabbing');
        }

        function onPointerMove(e){
          if (!dragging) return;
          const s = stage.getBoundingClientRect();
          const left = e.clientX - s.left - offsetX;
          const top  = e.clientY - s.top  - offsetY;
          setHandle(left, top);
        }

        function onPointerUp(e){
          dragging = false;
          handle.releasePointerCapture?.(e.pointerId);
          handle.classList.remove('cursor-grabbing');
          handle.classList.add('cursor-grab');
        }

        handle.addEventListener('pointerdown', onPointerDown);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);

        resetBtn.addEventListener('click', ()=>{
          const s = stage.getBoundingClientRect();
          evidenceEls.forEach(el=>{ el.style.opacity = '0'; });
          foundBadge.classList.add('hidden');
          foundSet.clear();
          counterBadge.textContent = `Found 0/${evidenceEls.length}`;
          setHandle(16, s.height/2 - handle.offsetHeight/2);
        });

        backBtn.addEventListener('click', ()=>{
          step = 3; // back to mini guide
          if (nextBtn) nextBtn.classList.add('hidden');
          renderMiniGuide();
        });

        doneBtn.addEventListener('click', ()=>{
          // After practice, mark Module 4 finished and go to Level 4
          if(window.ForensicFlow && typeof ForensicFlow.onModule4Finished === 'function'){
            ForensicFlow.onModule4Finished();
          } else {
            try{ localStorage.setItem('module4_done','true'); }catch(e){}
            window.location.href = '../levels/level4.html';
          }
        });
      }
      render();

      
    })();
  </script>
</body>
</html>